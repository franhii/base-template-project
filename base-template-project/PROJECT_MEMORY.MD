# PROJECT_MEMORY.md
> **PROP√ìSITO**: Contexto t√©cnico completo para Claude. Actualizar al final de cada sesi√≥n.
> **√öLTIMA ACTUALIZACI√ìN**: 2025-11-12

---

## üéØ PROYECTO: Core E-Commerce Multi-Tenant

### Stack
**Backend**: Spring Boot 3.2.0 + Java 21 + PostgreSQL + Maven
**Frontend**: React 18 + Vite + Axios + Context API
**Integraciones**: MercadoPago SDK 2.1.26 + GeoRef API + MercadoEnv√≠os

### Arquitectura Multi-Tenant
- **Estrategia**: Subdomain-based (beauty.app.com, gym.app.com)
- **Aislamiento**: Shared DB + Tenant discriminator en todas las entidades
- **Detecci√≥n**: TenantInterceptor ‚Üí TenantContext (ThreadLocal)
- **Desarrollo local**: Header `X-Tenant-Subdomain` para testing

---

## üìä MODELO DE DATOS (Core Entities)

### User
```java
@Entity class User {
  String id, name, email, phone, password;
  Role role; // SUPER_ADMIN, ADMIN, VENDEDOR, CLIENTE
  Tenant tenant; // ManyToOne
  LocalDateTime createdAt, updatedAt;
}
```

### Tenant
```java
@Entity class Tenant {
  String id, subdomain, businessName;
  BusinessType type; // GYM, RETAIL, BEAUTY_SALON, etc.
  boolean active; // ‚úÖ Suspensi√≥n de tenants
  TenantConfig config; // JSONB
  LocalDateTime createdAt;
}
```

### TenantConfig (JSONB)
```java
class TenantConfig {
  String primaryColor, secondaryColor, logo, favicon;
  String postalCode; // CP del negocio (para MercadoEnv√≠os)
  Features features; // productos, servicios, booking, mercadoPago, mercadoEnvios
  BookingConfig bookingConfig;
  SocialMedia socialMedia;
  List<String> categories;
}
```

### Address (NUEVO - Sistema de Direcciones)
```java
@Entity class Address {
  String id;
  User user; // ManyToOne
  Tenant tenant; // ManyToOne
  
  // Datos normalizados con GeoRef API
  String street, streetNumber;
  String provinceId, provinceName;       // GeoRef oficial
  String municipalityId, municipalityName; // GeoRef oficial
  String localityId, localityName;       // GeoRef oficial (opcional)
  String postalCode;                     // 4 d√≠gitos Argentina
  
  String apartment, reference;           // Opcionales
  Double latitude, longitude;            // Para c√°lculo de distancia
  boolean isDefault;                     // Direcci√≥n por defecto
  LocalDateTime createdAt, updatedAt;
}
```

### Item (Herencia JOINED)
```java
@Entity @Inheritance(JOINED)
abstract class Item {
  String id, name, description, imageUrl, category;
  BigDecimal price;
  Tenant tenant;
  boolean active;
}

@Entity class Product extends Item {
  Integer stock;
  String sku;
  ProductType type; // PHYSICAL, DIGITAL
}

@Entity class ServiceItem extends Item {
  Integer durationMinutes, maxCapacity;
  ScheduleType scheduleType; // ON_DEMAND, SCHEDULED, RECURRING
  boolean requiresBooking;
  Set<DayOfWeek> availableDays;
  LocalTime workStartTime, workEndTime;
  Integer slotIntervalMinutes;
}
```

### Order (ACTUALIZADO - Con Shipping)
```java
@Entity class Order {
  String id;
  User user;
  Tenant tenant;
  List<OrderItem> items; // @OneToMany
  BigDecimal total; // Incluye deliveryCost
  OrderStatus status; // PENDING, CONFIRMED, PREPARING, COMPLETED, CANCELLED
  PaymentMethod paymentMethod;
  String notes;
  
  // ========== SHIPPING (NUEVO) ==========
  Address deliveryAddress; // @ManyToOne (null si es pickup)
  BigDecimal deliveryCost; // Costo del env√≠o (de MercadoEnv√≠os)
  boolean isDelivery; // true = delivery, false = pickup
  String deliveryNotes; // Notas del cliente
  Long shippingMethodId; // ID de MercadoEnv√≠os (100009, 100012, etc.)
  String shipmentId; // ID del shipment en ML (para tracking)
  String shippingStatus; // pending, ready_to_ship, shipped, delivered
  
  LocalDateTime createdAt, updatedAt;
  
  // M√©todo helper
  BigDecimal getTotalWithDelivery(); // total + deliveryCost
}

@Entity class OrderItem {
  String id;
  Order order;
  Item item;
  Integer quantity;
  BigDecimal priceAtPurchase;
  String itemName, itemType; // Snapshot para items eliminados
  // Booking fields (solo si es servicio):
  LocalDate bookingDate;
  LocalTime bookingTime;
}
```

### Booking
```java
@Entity class Booking {
  String id;
  ServiceItem service;
  Order order;
  OrderItem orderItem;
  Tenant tenant;
  User user;
  LocalDate bookingDate;
  LocalTime startTime, endTime;
  BookingStatus status; // PENDING, CONFIRMED, CANCELLED, COMPLETED, NO_SHOW
  String customerName, customerEmail, customerPhone, notes;
}
```

### Payment
```java
@Entity class Payment {
  String id;
  Order order; // @OneToOne
  Tenant tenant;
  PaymentMethod method; // CASH, MERCADO_PAGO, BANK_TRANSFER, etc.
  PaymentStatus status; // PENDING, APPROVED, REJECTED, CANCELLED
  BigDecimal amount;
  String externalId, externalStatus, paymentLink;
  String receiptUrl, receiptNotes; // Para comprobantes manuales
  LocalDateTime createdAt, confirmedAt;
}
```

---

## üîê SEGURIDAD & AUTENTICACI√ìN

### JWT
- **Secret**: APP_JWT_SECRET (env)
- **Expiration**: APP_JWT_EXP_MS (env, default 24h)
- **Claims**: email (subject), userId, role
- **Filter**: JwtAuthenticationFilter ‚Üí SecurityContext

### Roles & Permisos
```java
// SUPER_ADMIN: Gestiona toda la plataforma (/api/super-admin/**)
// ADMIN: Gestiona su tenant (/api/admin/**)
// VENDEDOR: CRUD items de su tenant
// CLIENTE: Compras, reservas, perfil, direcciones
```

### SecurityConfig
- **CORS**: Habilitado para localhost:5173, incluye X-Tenant-Subdomain
- **CSRF**: Disabled (JWT stateless)
- **Public endpoints**: /api/auth/**, /api/config/current, /api/items/** (GET), /api/payments/** (webhooks), /api/georef/**

---

## üåê BACKEND: ENDPOINTS PRINCIPALES

### Auth (/api/auth)
- `POST /register` ‚Üí Crea User + rol CLIENTE + tenant default
- `POST /login` ‚Üí Retorna JWT
- `GET /me` ‚Üí User actual (requiere auth)

### Items (/api/items)
- `GET /products` ‚Üí Lista productos del tenant actual
- `GET /services` ‚Üí Lista servicios del tenant actual
- `POST /products` ‚Üí Crea producto (ADMIN/VENDEDOR)
- `POST /services` ‚Üí Crea servicio (ADMIN/VENDEDOR)

### Addresses (/api/addresses) - NUEVO
- `POST /` ‚Üí Crear direcci√≥n (con GeoRef)
- `GET /` ‚Üí Listar mis direcciones
- `GET /default` ‚Üí Obtener direcci√≥n por defecto
- `GET /{id}` ‚Üí Obtener direcci√≥n espec√≠fica
- `PUT /{id}` ‚Üí Actualizar direcci√≥n
- `PATCH /{id}/set-default` ‚Üí Marcar como default
- `DELETE /{id}` ‚Üí Eliminar direcci√≥n

### GeoRef (/api/georef) - NUEVO (P√∫blico)
- `GET /provinces` ‚Üí Todas las provincias argentinas
- `GET /municipalities?provinceId=X` ‚Üí Municipios por provincia
- `GET /municipalities/search?query=X` ‚Üí Buscar municipios (autocomplete)
- `GET /localities?municipalityId=X` ‚Üí Localidades por municipio

### Shipping (/api/shipping) - NUEVO (MercadoEnv√≠os)
- `POST /quote` ‚Üí Cotizar opciones de env√≠o
   - Body: `{ addressId, orderTotal, dimensions? }`
   - Retorna opciones de MercadoEnv√≠os con precios
- `GET /available/{addressId}` ‚Üí Validar disponibilidad de env√≠o

### Orders (/api/orders)
- `POST /` ‚Üí Crea orden + reserva stock + crea bookings + calcula env√≠o
   - Validaci√≥n autom√°tica de shipping si isDelivery=true
   - Integraci√≥n con MercadoEnv√≠os
- `GET /my-orders` ‚Üí √ìrdenes del user
- `GET /` ‚Üí Todas las √≥rdenes del tenant (ADMIN/VENDEDOR)
- `POST /{id}/cancel` ‚Üí Cancela orden + restaura stock

### Payments (/api/payments)
- `POST /` ‚Üí Crea pago (MP o manual)
- `POST /upload-receipt` ‚Üí Sube comprobante (transferencias)
- `PATCH /{id}/approve` ‚Üí Aprueba pago manual (ADMIN/VENDEDOR)
- `PATCH /{id}/reject` ‚Üí Rechaza pago + restaura stock
- `POST /webhook/mercadopago` ‚Üí Webhook de MP (p√∫blico)
- `GET /success, /failure, /pending` ‚Üí Redirects de MP

### Bookings (/api/bookings)
- `GET /available?serviceId=X&date=Y` ‚Üí Slots disponibles
- `POST /` ‚Üí Crea booking (status PENDING hasta pago)
- `POST /{id}/cancel` ‚Üí Cancela booking (24hs antes m√≠nimo)
- `GET /my-bookings` ‚Üí Bookings del user

### Admin (/api/admin)
- `GET /users` ‚Üí Todos los usuarios
- `POST /users` ‚Üí Crea usuario con tenant espec√≠fico
- `PATCH /users/{id}/role` ‚Üí Cambia rol

### Admin Stats (/api/admin/stats)
- `GET /dashboard` ‚Üí KPIs (ventas, √≥rdenes, clientes, revenue)
- `GET /daily-sales?days=30` ‚Üí Ventas diarias (chart)
- `GET /pending-payments` ‚Üí Pagos pendientes revisi√≥n
- `GET /top-products?limit=10` ‚Üí Productos m√°s vendidos
- `GET /payment-methods` ‚Üí Distribuci√≥n m√©todos de pago
- `GET /order-status` ‚Üí Distribuci√≥n estados √≥rdenes

### Customer (/api/customer)
- `GET /profile` ‚Üí Perfil del user
- `PUT /profile` ‚Üí Actualiza perfil (nombre, tel√©fono)
- `GET /orders` ‚Üí Mis √≥rdenes
- `GET /bookings` ‚Üí Mis reservas
- `GET /bookings/upcoming` ‚Üí Pr√≥ximas reservas
- `POST /bookings/{id}/cancel` ‚Üí Cancela reserva (24hs antes)
- `GET /stats` ‚Üí Estad√≠sticas del cliente

### Super Admin (/api/super-admin)
- `GET /tenants` ‚Üí TODOS los tenants (sin filtro)
- `POST /tenants` ‚Üí Crea tenant
- `PUT /tenants/{id}` ‚Üí Actualiza tenant
- `PATCH /tenants/{id}/toggle-status` ‚Üí Activa/Suspende tenant
- `PATCH /tenants/{id}/features` ‚Üí Actualiza features del tenant
- `POST /services` ‚Üí Crea servicio para un tenant espec√≠fico

### Config (/api/config)
- `GET /current` ‚Üí Configuraci√≥n del tenant actual (p√∫blico)

---

## üé® FRONTEND: ESTRUCTURA

### Context & State
```javascript
// CartContext: cart, addToCart, removeFromCart, updateQuantity, clearCart, getTotal, getTotalItems
// Persistencia en localStorage
// Validaci√≥n de stock en addToCart/updateQuantity
```

### P√°ginas
```
HomePage ‚Üí Lista productos/servicios (tabs)
LoginPage / RegisterPage
CartPage ‚Üí Lista items + summary + validaciones stock
CheckoutPage ‚Üí Selector m√©todo pago + direcci√≥n + env√≠o ‚Üí Crea orden + pago ‚Üí Redirige a MP o success
SuccessPage / FailurePage / PendingPage ‚Üí Resultados MP
AdminPage ‚Üí Dashboard (Recharts) + Pending payments table
ManageItemsPage ‚Üí CRUD productos/servicios (tabs) + booking config
MyAccountPage ‚Üí Tabs: Overview (stats), √ìrdenes, Reservas, Perfil, Direcciones (NUEVO)
SuperAdminPage ‚Üí Tabla tenants + Edit/Suspend + Crear servicio
NotFoundPage
```

### Componentes
```
Navbar ‚Üí Logo, links, carrito badge, user dropdown, roles
ProductCard / ServiceCard ‚Üí Imagen, precio, stock, agregar carrito
BookingModal ‚Üí Selector fecha + slots disponibles
Toast ‚Üí Notificaciones (success, error, warning)
ConfirmModal ‚Üí Confirmaciones (cancelar booking, vaciar carrito, etc.)
EditTenantModal ‚Üí Editar tenant (nombre, tipo, features)
AdminDashboard ‚Üí KPIs + charts (Recharts)
AddressManager ‚Üí CRUD direcciones (pendiente frontend)
AddressForm ‚Üí Formulario con GeoRef autocomplete (pendiente frontend)
ShippingSelector ‚Üí Selector de opciones de env√≠o (pendiente frontend)
```

### Servicios API
```javascript
// api.js: axios instance con JWT interceptor + tenant header
// authService: register, login, getCurrentUser
// itemService: getProducts, getServices, createProduct, createService
// tenantService: getCurrentConfig
// addressService: CRUD direcciones (pendiente)
// shippingService: quoteShipping (pendiente)
// setTenantHeader(subdomain) ‚Üí Para testing multi-tenant
```

---

## üîÑ FLUJOS CR√çTICOS
---

## üîÑ PENDIENTE (TODO.md - Priorizado)

### üî• Prioridad Alta (Siguiente Sesi√≥n - 2025-11-13)

**OBJETIVO**: Completar frontend de Direcciones y Env√≠o

1. **AddressForm.jsx** (NUEVO)
    - [ ] Modal/Form con campos de direcci√≥n
    - [ ] Integraci√≥n con GeoRef API (provinces, municipalities, localities)
    - [ ] Autocompletado en cascada (Provincia ‚Üí Municipio ‚Üí Localidad)
    - [ ] Validaci√≥n CP 4 d√≠gitos
    - [ ] Checkbox "Marcar como default"
    - [ ] Modos: create/edit

2. **AddressManager.jsx** (NUEVO)
    - [ ] Listar direcciones del usuario
    - [ ] Card por direcci√≥n con badge "Default"
    - [ ] Botones: Editar, Eliminar, Set Default
    - [ ] Bot√≥n "Agregar Direcci√≥n" ‚Üí Abre AddressForm
    - [ ] Empty state si no hay direcciones
    - [ ] ConfirmModal para eliminaci√≥n

3. **ShippingSelector.jsx** (NUEVO)
    - [ ] Radio: "Retiro en local" / "Env√≠o a domicilio"
    - [ ] Si delivery: Selector de direcci√≥n existente
    - [ ] Bot√≥n "Agregar nueva direcci√≥n"
    - [ ] POST /api/shipping/quote al seleccionar direcci√≥n
    - [ ] Mostrar opciones MercadoEnv√≠os con precios
    - [ ] Badge "GRATIS" si cost = 0
    - [ ] Radio buttons para elegir opci√≥n de env√≠o
    - [ ] Actualizar total del checkout

4. **MyAccountPage.jsx** (MODIFICAR)
    - [ ] Agregar tab "üìç Direcciones"
    - [ ] Renderizar <AddressManager /> en el tab

5. **CheckoutPage.jsx** (MODIFICAR)
    - [ ] Agregar estados: deliveryType, selectedAddress, shippingOptions, selectedShipping, deliveryCost
    - [ ] Integrar <ShippingSelector />
    - [ ] Calcular totalWithShipping
    - [ ] Enviar isDelivery, deliveryAddressId, shippingMethodId en orderData

6. **Testing E2E**
    - [ ] Flujo: Crear direcci√≥n ‚Üí Cotizar env√≠o ‚Üí Comprar con delivery
    - [ ] Flujo: Retiro en local (sin env√≠o)
    - [ ] Validar que Order se cree con shipping data
    - [ ] Verificar total incluye deliveryCost

### üìã Prioridad Media

7. **Tracking de Env√≠os** (Futuro)
    - [ ] Crear shipment en MercadoEnv√≠os post-pago
    - [ ] Guardar shipmentId en Order
    - [ ] Endpoint GET /api/orders/{id}/tracking
    - [ ] Frontend: Mostrar estado de env√≠o en "Mis √ìrdenes"

8. **WhatsApp Floating Button**
    - [ ] Bot√≥n flotante esquina inferior derecha
    - [ ] N√∫mero configurable en TenantConfig
    - [ ] Link directo wa.me

9. **Google OAuth Login**
    - [ ] Login con Google
    - [ ] Auto-registro si no existe
    - [ ] Mantener JWT existente

### üîß Refactoring & Performance
- [ ] Agregar soft-delete a entidades cr√≠ticas
- [ ] Cache configuraci√≥n tenants (Redis)
- [ ] √çndices BD para performance (Address por user/tenant)
- [ ] Rate limiting endpoints p√∫blicos
- [ ] Logging estructurado (SLF4J)

### üêõ Bugs Conocidos
- [ ] Validar webhooks MP en producci√≥n (ngrok ‚Üí dominio real)
- [ ] Manejo de timezones en bookings
- [ ] Validar emails √∫nicos por tenant

---

## üìù DECISIONES T√âCNICAS IMPORTANTES

### ¬øPor qu√© GeoRef API en lugar de campos libres?
- API oficial del gobierno argentino (gratis, datos actualizados)
- IDs oficiales de provincias/municipios
- Mejor UX con autocomplete
- Preparado para validaciones de CP

### ¬øPor qu√© MercadoEnv√≠os en lugar de Andreani/OCA directo?
- **No requiere contrato corporativo** (solo API key)
- Mismas credenciales que MercadoPago
- Mejores tarifas (econom√≠as de escala)
- Tracking incluido
- M√∫ltiples couriers en uno (Correo Argentino + Andreani)
- Puntos de retiro en todo el pa√≠s
- Confianza del usuario

### ¬øPor qu√© separar street y streetNumber?
- Requerimiento de couriers (necesitan separados)
- Mejor b√∫squeda y filtrado
- Validaciones m√°s precisas
- Compatibilidad con APIs de mapas

### ¬øPor qu√© ThreadLocal para TenantContext?
- Aislamiento autom√°tico por request
- No contamina par√°metros de m√©todos
- Compatible con transacciones Spring

### ¬øPor qu√© snapshot en OrderItem?
- Preserva datos si se elimina Item
- Auditabilidad (precio al momento de compra)
- Evita inconsistencias en reportes hist√≥ricos

### ¬øPor qu√© JSONB para TenantConfig?
- Flexibilidad para configs custom por tenant
- No requiere migraciones para agregar campos
- PostgreSQL indexa JSONB eficientemente

### ¬øPor qu√© external_reference en MP en lugar de payment_id?
- MP puede reintentar pagos con mismo payment_id
- external_reference es nuestro Order.id (√∫nico)
- Evita duplicados y facilita tracking

---

## üîó LINKS IMPORTANTES

- **Chat anteriores**:
    - https://claude.ai/chat/f73e801d-c1ea-45ee-8a89-e517c03886ee (Sesi√≥n 1)
    - https://claude.ai/chat/f052be26-377a-40ee-a877-08cfae28a7b3 (Sesi√≥n 2)
    - [SESI√ìN_ACTUAL_2025-11-12] (Sesi√≥n 3 - Backend Direcciones + MercadoEnv√≠os)
- **Repo Git**: https://github.com/franhii/base-template-project
- **Docs MP**: https://www.mercadopago.com.ar/developers/es/docs
- **GeoRef API**: https://apis.datos.gob.ar/georef/api/
- **MercadoEnv√≠os API**: https://developers.mercadolibre.com.ar/es_ar/envios

---

## üìä M√âTRICAS DEL PROYECTO

- **Backend**: ~100 archivos Java
- **Frontend**: ~45 archivos JSX/CSS (estimado con nuevos componentes)
- **Total LOC**: ~20,000 (estimado)
- **Endpoints**: ~70
- **Entidades**: 12 principales
- **Tiempo desarrollo**: 3 sesiones intensivas

---

## üéØ PR√ìXIMA SESI√ìN (2025-11-13)

**Objetivo**: Frontend completo de Direcciones y Env√≠o
**Archivos a crear**:
- AddressForm.jsx + CSS
- AddressManager.jsx + CSS
- ShippingSelector.jsx + CSS

**Archivos a modificar**:
- MyAccountPage.jsx (agregar tab)
- CheckoutPage.jsx (integrar shipping)

**Resultado esperado**:
- Usuario puede gestionar direcciones en "Mi Cuenta"
- Checkout con selector de env√≠o funcional
- Cotizaci√≥n en tiempo real con MercadoEnv√≠os
- Compra completa con delivery/pickup
- Testing E2E exitoso del flujo

---

## üìñ GLOSARIO

- **Tenant**: Cliente/negocio que usa la plataforma
- **Item**: Abstracci√≥n de Product + ServiceItem
- **Booking**: Reserva de un servicio en fecha/hora espec√≠fica
- **OrderItem**: L√≠nea de una orden (puede incluir booking data)
- **Slot**: Horario disponible para reserva
- **External Reference**: ID de nuestra orden usado en MercadoPago
- **Snapshot**: Copia de datos al momento de la transacci√≥n (ej: priceAtPurchase)
- **GeoRef**: API del gobierno argentino para normalizar direcciones
- **MercadoEnv√≠os**: Sistema de log√≠stica de MercadoLibre
- **Shipping Method ID**: ID √∫nico de un m√©todo de env√≠o (ej: 100009 = Est√°ndar)
- **Shipment ID**: ID del env√≠o en MercadoLibre para tracking

---

**üîÑ ACTUALIZAR ESTE ARCHIVO AL FINAL DE CADA SESI√ìN**