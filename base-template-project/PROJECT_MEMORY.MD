# PROJECT_MEMORY.md
> **PROP√ìSITO**: Contexto t√©cnico completo para Claude. Actualizar al final de cada sesi√≥n.
> **√öLTIMA ACTUALIZACI√ìN**: 2025-11-15

---

## üéØ PROYECTO: Core E-Commerce Multi-Tenant

### Stack
**Backend**: Spring Boot 3.2.0 + Java 21 + PostgreSQL + Maven
**Frontend**: React 18 + Vite + Axios + Context API + CSS Vanilla
**Integraciones**: MercadoPago SDK 2.1.26 + GeoRef API + MercadoEnv√≠os

### Arquitectura Multi-Tenant
- **Estrategia**: Subdomain-based (beauty.app.com, gym.app.com)
- **Aislamiento**: Shared DB + Tenant discriminator en todas las entidades
- **Detecci√≥n**: TenantInterceptor ‚Üí TenantContext (ThreadLocal)
- **Desarrollo local**: Header `X-Tenant-Subdomain` para testing

---

## üìä MODELO DE DATOS (Core Entities)

### User
```java
@Entity class User {
  String id, name, email, phone, password;
  Role role; // SUPER_ADMIN, ADMIN, VENDEDOR, CLIENTE
  Tenant tenant; // ManyToOne
  LocalDateTime createdAt, updatedAt;
}
```

### Tenant
```java
@Entity class Tenant {
  String id, subdomain, businessName;
  BusinessType type; // GYM, RETAIL, BEAUTY_SALON, etc.
  boolean active; // ‚úÖ Suspensi√≥n de tenants
  TenantConfig config; // JSONB
  LocalDateTime createdAt;
}
```

### TenantConfig (JSONB)
```java
class TenantConfig {
  String primaryColor, secondaryColor, logo, favicon;
  String postalCode; // CP del negocio (para MercadoEnv√≠os)
  Features features; // productos, servicios, booking, mercadoPago, mercadoEnvios
  BookingConfig bookingConfig;
  SocialMedia socialMedia;
  List<String> categories;
}
```

### Address
```java
@Entity class Address {
  String id;
  User user; // ManyToOne
  Tenant tenant; // ManyToOne
  
  // Datos normalizados con GeoRef API
  String street, streetNumber;
  String provinceId, provinceName;       // GeoRef oficial
  String municipalityId, municipalityName; // GeoRef oficial
  String localityId, localityName;       // GeoRef oficial (opcional)
  String postalCode;                     // 4 d√≠gitos Argentina
  
  String apartment, reference;           // Opcionales
  Double latitude, longitude;            // Para c√°lculo de distancia
  boolean isDefault;                     // Direcci√≥n por defecto
  LocalDateTime createdAt, updatedAt;
}
```

### Item (Herencia JOINED)
```java
@Entity @Inheritance(JOINED)
abstract class Item {
  String id, name, description, imageUrl, category;
  BigDecimal price;
  Tenant tenant;
  boolean active;
}

@Entity class Product extends Item {
  Integer stock;
  String sku;
  ProductType type; // PHYSICAL, DIGITAL
}

@Entity class ServiceItem extends Item {
  Integer durationMinutes, maxCapacity;
  ScheduleType scheduleType; // ON_DEMAND, SCHEDULED, RECURRING
  boolean requiresBooking;
  Set<DayOfWeek> availableDays;
  LocalTime workStartTime, workEndTime;
  Integer slotIntervalMinutes;
}
```

### Order
```java
@Entity class Order {
  String id;
  User user;
  Tenant tenant;
  List<OrderItem> items; // @OneToMany
  BigDecimal total; // Incluye deliveryCost
  OrderStatus status; // PENDING, CONFIRMED, PREPARING, COMPLETED, CANCELLED
  PaymentMethod paymentMethod;
  String notes;
  
  // ========== SHIPPING ==========
  Address deliveryAddress; // @ManyToOne (null si es pickup)
  BigDecimal deliveryCost; // Costo del env√≠o (de MercadoEnv√≠os)
  boolean isDelivery; // true = delivery, false = pickup
  String deliveryNotes; // Notas del cliente
  Long shippingMethodId; // ID de MercadoEnv√≠os (100009, 100012, etc.)
  String shipmentId; // ID del shipment en ML (para tracking)
  String shippingStatus; // pending, ready_to_ship, shipped, delivered
  
  LocalDateTime createdAt, updatedAt;
}

@Entity class OrderItem {
  String id;
  Order order;
  Item item;
  Integer quantity;
  BigDecimal priceAtPurchase;
  String itemName, itemType; // Snapshot para items eliminados
  // Booking fields (solo si es servicio):
  LocalDate bookingDate;
  LocalTime bookingTime;
}
```

### Booking
```java
@Entity class Booking {
  String id;
  ServiceItem service;
  Order order;
  OrderItem orderItem;
  Tenant tenant;
  User user;
  LocalDate bookingDate;
  LocalTime startTime, endTime;
  BookingStatus status; // PENDING, CONFIRMED, CANCELLED, COMPLETED, NO_SHOW
  String customerName, customerEmail, customerPhone, notes;
}
```

### Payment
```java
@Entity class Payment {
  String id;
  Order order; // @OneToOne
  Tenant tenant;
  PaymentMethod method; // CASH, MERCADO_PAGO, BANK_TRANSFER, etc.
  PaymentStatus status; // PENDING, APPROVED, REJECTED, CANCELLED
  BigDecimal amount;
  String externalId, externalStatus, paymentLink;
  String receiptUrl, receiptNotes; // Para comprobantes manuales
  LocalDateTime createdAt, confirmedAt;
}
```

---

## üîê SEGURIDAD & AUTENTICACI√ìN

### JWT
- **Secret**: APP_JWT_SECRET (env)
- **Expiration**: APP_JWT_EXP_MS (env, default 24h)
- **Claims**: email (subject), userId, role
- **Filter**: JwtAuthenticationFilter ‚Üí SecurityContext

### Roles & Permisos
```java
// SUPER_ADMIN: Gestiona toda la plataforma (/api/super-admin/**)
// ADMIN: Gestiona su tenant (/api/admin/**)
// VENDEDOR: CRUD items de su tenant
// CLIENTE: Compras, reservas, perfil, direcciones
```

### SecurityConfig
- **CORS**: Habilitado para localhost:5173, incluye X-Tenant-Subdomain
- **CSRF**: Disabled (JWT stateless)
- **Public endpoints**: /api/auth/**, /api/config/current, /api/items/** (GET), /api/payments/webhook/**, /api/georef/**, /api/shipping/**

---

## üåê BACKEND: ENDPOINTS PRINCIPALES

### Shipping (/api/shipping) - MercadoEnv√≠os
- `POST /quote-by-postalcode` ‚Üí Cotizar con CP (4 d√≠gitos)
   - Body: `{ postalCode: "2600", orderTotal: 15000 }`
   - Retorna: `[{ shippingMethodId, name, cost, estimatedDelivery, carrier, isFree }]`
   - Validaciones: CP del tenant en config, formato 4 d√≠gitos

- `POST /quote` ‚Üí Cotizar con addressId
   - Body: `{ addressId: "uuid", orderTotal: 15000 }`
   - Usa CP de la direcci√≥n seleccionada

### Addresses (/api/addresses)
- `POST /` ‚Üí Crear direcci√≥n (con GeoRef)
- `GET /` ‚Üí Listar mis direcciones
- `GET /default` ‚Üí Obtener direcci√≥n por defecto
- `GET /{id}` ‚Üí Obtener direcci√≥n espec√≠fica
- `PUT /{id}` ‚Üí Actualizar direcci√≥n
- `PATCH /{id}/set-default` ‚Üí Marcar como default
- `DELETE /{id}` ‚Üí Eliminar direcci√≥n

### GeoRef (/api/georef) - P√∫blico
- `GET /provinces` ‚Üí Todas las provincias argentinas
- `GET /municipalities?provinceId=X` ‚Üí Municipios por provincia
- `GET /municipalities/search?query=X` ‚Üí Buscar municipios (autocomplete)
- `GET /localities?municipalityId=X` ‚Üí Localidades por municipio

### Orders (/api/orders)
- `POST /` ‚Üí Crea orden + reserva stock + crea bookings + calcula env√≠o
   - Body incluye: `isDelivery, deliveryAddressId?, shippingMethodId?, deliveryNotes?`
   - Validaci√≥n autom√°tica de shipping si isDelivery=true
- `GET /my-orders` ‚Üí √ìrdenes del user
- `GET /` ‚Üí Todas las √≥rdenes del tenant (ADMIN/VENDEDOR)
- `POST /{id}/cancel` ‚Üí Cancela orden + restaura stock

### Payments, Bookings, Auth, Items... (resto igual)

---

## üé® FRONTEND: ESTRUCTURA

### Servicios API (services/api.js)
```javascript
// api.js: axios instance con JWT interceptor + tenant header
// BASE_URL: import.meta.env.VITE_API_URL || 'http://localhost:8080'

// Interceptor request: Agrega Authorization Bearer token
// Interceptor response: 401 ‚Üí localStorage.removeItem('token')

// Servicios exportados:
authService: { register, login, getCurrentUser }
itemService: { getProducts, getServices, createProduct, createService }
tenantService: { getCurrentConfig }

// Helper multi-tenancy:
setTenantHeader(subdomain) // Setea X-Tenant-Subdomain
```

### Context & State
```javascript
// CartContext (store/CartContext.jsx)
cart: Array<{id, name, price, quantity, stock?, bookingDate?, bookingTime?}>

M√©todos:
- addToCart(item, qty) ‚Üí valida stock
- removeFromCart(id)
- updateQuantity(id, qty) ‚Üí valida stock
- clearCart()
- getTotal() ‚Üí sum(price * quantity)
- getTotalItems() ‚Üí sum(quantity)

Persistencia: localStorage auto-save/load
```

### P√°ginas Principales
```
HomePage ‚Üí Tabs (Todo/Productos/Servicios) + Grid de cards
CartPage ‚Üí Items + Summary (subtotal + IVA 21% + total)
CheckoutPage ‚Üí M√©todo pago + (PENDIENTE: ShippingSelector)
MyAccountPage ‚Üí Tabs: Overview, √ìrdenes, Reservas, Perfil (PENDIENTE: Direcciones)
AdminPage ‚Üí <AdminDashboard /> (KPIs + Recharts + Pending payments)
ManageItemsPage ‚Üí CRUD productos/servicios (tabs)
SuperAdminPage ‚Üí Tabla tenants + CRUD
SuperAdminServiceCreationPage ‚Üí Crear servicio para tenant espec√≠fico
LoginPage / RegisterPage
SuccessPage / FailurePage / PendingPage (MP callbacks)
NotFoundPage
```

### Componentes Cr√≠ticos
```
Navbar ‚Üí Logo din√°mico, cart badge, links por rol
ProductCard / ServiceCard ‚Üí Validaci√≥n stock, badges
BookingModal ‚Üí Selector fecha + slots disponibles
Toast ‚Üí Notificaciones (4 tipos)
ConfirmModal ‚Üí Confirmaciones
AdminDashboard ‚Üí Recharts (LineChart, PieChart, BarChart)
EditTenantModal
```

### Componentes CSS (IMPORTANTE - No modificar estructura)
```
Todos los componentes usan CSS Vanilla con clases propias
NO usar Tailwind ni cambiar nombres de clases existentes
Mantener estructura de divs original
Grid layouts con display: grid y auto-fit/auto-fill
Responsive con @media queries
```

---

## üîÑ FLUJOS CR√çTICOS

### Compra con Env√≠o (En Desarrollo)
```
1. HomePage ‚Üí Agregar productos al carrito
2. CartPage ‚Üí Revisar items
   ‚îî‚îÄ NUEVO: ShippingPreview (cotizaci√≥n preliminar por CP)
3. CheckoutPage
   ‚îú‚îÄ Selector delivery/pickup
   ‚îú‚îÄ Si delivery: Selector de direcci√≥n
   ‚îú‚îÄ POST /api/shipping/quote-by-postalcode
   ‚îú‚îÄ Mostrar opciones de env√≠o con precios
   ‚îî‚îÄ Calcular totalWithShipping
4. POST /api/orders (incluye shippingMethodId, addressId)
5. POST /api/payments
6. Redirect a MercadoPago o success
```

### Reserva de Servicio con Booking
```
1. HomePage ‚Üí ServiceCard (requiresBooking)
2. Click "Reservar" ‚Üí BookingModal
3. Seleccionar fecha ‚Üí GET /api/bookings/available
4. Seleccionar slot ‚Üí addToCart con bookingDate/Time
5. CartPage ‚Üí Checkout normal
6. Pago aprobado ‚Üí Booking.status = CONFIRMED
```

---

## üîÑ PENDIENTE (Priorizado)

### üî• PRIORIDAD 1 - Frontend Shipping (AHORA)

**CONTEXTO**: Backend de shipping YA est√° implementado. Necesitamos frontend.

**COMPONENTES A CREAR**:

1. **ShippingPreview.jsx** (CartPage) ‚úÖ CREADO PERO REVISAR
   - Input c√≥digo postal (4 d√≠gitos)
   - Bot√≥n "Calcular env√≠o"
   - POST /api/shipping/quote-by-postalcode
   - Mostrar opciones: nombre, costo, tiempo estimado, courier
   - Radio buttons para seleccionar
   - Badge "GRATIS" si isFree
   - Nota: "Costo final se confirma en checkout"
   - **PROBLEMA ACTUAL**: Cambios en estructura CSS/divs

2. **ShippingSelector.jsx** (CheckoutPage) - PENDIENTE
   - Radio: "Retiro en local" / "Env√≠o a domicilio"
   - Si delivery:
      * Selector de direcci√≥n (GET /api/addresses)
      * Bot√≥n "Agregar direcci√≥n" (futuro AddressForm)
      * POST /api/shipping/quote al seleccionar direcci√≥n
      * Mostrar opciones MercadoEnv√≠os
      * Radio para elegir m√©todo
   - Actualizar estado: deliveryType, selectedAddress, shippingMethod, deliveryCost

3. **CartPage.jsx** - MODIFICAR
   - Integrar <ShippingPreview /> en sidebar
   - Mostrar costo estimado en summary (si hay)
   - Nota aclaratoria sobre estimaci√≥n

4. **CheckoutPage.jsx** - MODIFICAR
   - Integrar <ShippingSelector />
   - Estados: isDelivery, deliveryAddressId, shippingMethodId, deliveryCost
   - Calcular totalWithShipping
   - Enviar datos shipping en POST /api/orders

**ARCHIVOS EXISTENTES A REVISAR**:
- `ShippingPreview.jsx` ‚úÖ Existe
- `ShippingPreview.css` ‚úÖ Existe
- `CartPage.jsx` ‚ö†Ô∏è Verificar integraci√≥n
- `CartPage.css` ‚ö†Ô∏è Verificar que no se rompi√≥ estructura

**TESTING**:
- [ ] Flujo: Calcular env√≠o en cart ‚Üí Ver opciones ‚Üí Continuar checkout
- [ ] Flujo: Checkout con retiro en local
- [ ] Flujo: Checkout con delivery (cuando AddressManager est√© listo)

---

### üî• PRIORIDAD 2 - Frontend Direcciones

**AddressManager.jsx** - PENDIENTE
- Listar direcciones (GET /api/addresses)
- Cards con badge "Default"
- Botones: Editar, Eliminar, Set Default
- Empty state
- ConfirmModal para delete

**AddressForm.jsx** - PENDIENTE
- Modal con campos street, streetNumber, apartment, reference
- Autocompletado GeoRef:
   * Provincias (GET /api/georef/provinces)
   * Municipios (GET /api/georef/municipalities?provinceId=X)
   * Localidades (GET /api/georef/localities?municipalityId=X)
- Input CP (4 d√≠gitos)
- Checkbox isDefault
- POST /api/addresses o PUT /api/addresses/{id}

**MyAccountPage.jsx** - MODIFICAR
- Agregar tab "üìç Direcciones"
- Renderizar <AddressManager />

---

### üìã PRIORIDAD 3 - Mejoras

- Tracking de env√≠os (shipmentId en Order)
- WhatsApp floating button
- Google OAuth
- Soft-delete entities
- Cache config tenants
- Rate limiting
- Logging estructurado

---

## üìù DECISIONES T√âCNICAS CLAVE

### ¬øPor qu√© ShippingPreview en CartPage?
- **UX**: Usuario ve costo estimado ANTES de checkout
- **Conversi√≥n**: Reduce abandono (transparencia de costos)
- **Limitaci√≥n**: Solo cotiza por CP (no requiere direcci√≥n completa a√∫n)

### ¬øPor qu√© separar ShippingPreview y ShippingSelector?
- **ShippingPreview** (Cart): Estimaci√≥n r√°pida, solo CP
- **ShippingSelector** (Checkout): Selecci√≥n final con direcci√≥n completa
- Evita UX confuso (dos lugares haciendo lo mismo)

### ¬øPor qu√© no modificar estructura CSS existente?
- **Estabilidad**: Componentes ya funcionales y testeados
- **Responsive**: Media queries ya ajustadas
- **Consistencia**: Dise√±o unificado en toda la app
- **Tiempo**: Evita refactorings innecesarios

### ¬øPor qu√© MercadoEnv√≠os?
- No requiere contrato corporativo
- Mismas credenciales que MercadoPago
- M√∫ltiples couriers (Correo Argentino + Andreani)
- Tracking incluido
- Tarifas competitivas

---

## üîó LINKS IMPORTANTES

- **Chat anteriores**:
   - https://claude.ai/chat/f73e801d-c1ea-45ee-8a89-e517c03886ee (Sesi√≥n 1)
   - https://claude.ai/chat/f052be26-377a-40ee-a877-08cfae28a7b3 (Sesi√≥n 2)
   - https://claude.ai/chat/34892749-e9fd-4463-b8af-a25605b78d5c (Sesi√≥n 3)
   - https://claude.ai/chat/a20c1ea9-e0b5-4552-a346-2a7f57a43937 (Sesion 4)
- **Repo Git**: https://github.com/franhii/base-template-project
- **Docs MP**: https://www.mercadopago.com.ar/developers/es/docs
- **GeoRef API**: https://apis.datos.gob.ar/georef/api/
- **MercadoEnv√≠os API**: https://developers.mercadolibre.com.ar/es_ar/envios

---

## üéØ PR√ìXIMA ACCI√ìN INMEDIATA

**OBJETIVO**: Revisar y corregir ShippingPreview.jsx + Integraci√≥n en CartPage

**PASOS**:
1. Revisar ShippingPreview.jsx (verificar estructura original)
2. Revisar CartPage.jsx (verificar integraci√≥n correcta)
3. Testear flujo de cotizaci√≥n
4. Si funciona ‚Üí Continuar con ShippingSelector.jsx
5. Si hay problemas ‚Üí Corregir manteniendo CSS original

**ARCHIVOS A REVISAR**:
- `/frontend/src/pages/ShippingPreview.jsx`
- `/frontend/src/pages/ShippingPreview.css`
- `/frontend/src/pages/CartPage.jsx`
- `/frontend/src/pages/CartPage.css`

---

**üîÑ ACTUALIZAR ESTE ARCHIVO AL FINAL DE CADA SESI√ìN**