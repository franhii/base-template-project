# PROJECT_MEMORY.md
> **PROP√ìSITO**: Contexto t√©cnico completo para Claude. Actualizar al final de cada sesi√≥n.
> **√öLTIMA ACTUALIZACI√ìN**: 2025-11-10

---

## üéØ PROYECTO: Core E-Commerce Multi-Tenant

### Stack
**Backend**: Spring Boot 3.2.0 + Java 21 + PostgreSQL + Maven
**Frontend**: React 18 + Vite + Axios + Context API
**Integraciones**: MercadoPago SDK 2.1.26

### Arquitectura Multi-Tenant
- **Estrategia**: Subdomain-based (beauty.app.com, gym.app.com)
- **Aislamiento**: Shared DB + Tenant discriminator en todas las entidades
- **Detecci√≥n**: TenantInterceptor ‚Üí TenantContext (ThreadLocal)
- **Desarrollo local**: Header `X-Tenant-Subdomain` para testing

---

## üìä MODELO DE DATOS (Core Entities)

### User
```java
@Entity class User {
  String id, name, email, phone, password;
  Role role; // SUPER_ADMIN, ADMIN, VENDEDOR, CLIENTE
  Tenant tenant; // ManyToOne
  LocalDateTime createdAt, updatedAt;
}
```

### Tenant
```java
@Entity class Tenant {
  String id, subdomain, businessName;
  BusinessType type; // GYM, RETAIL, BEAUTY_SALON, etc.
  boolean active; // ‚úÖ Suspensi√≥n de tenants
  TenantConfig config; // JSONB
  LocalDateTime createdAt;
}
```

### TenantConfig (JSONB)
```java
class TenantConfig {
  String primaryColor, secondaryColor, logo, favicon;
  Features features; // productos, servicios, booking, mercadoPago, etc.
  DeliveryConfig deliveryConfig; // freeDeliveryThreshold, deliveryCost, zones
  BookingConfig bookingConfig;
  SocialMedia socialMedia;
  List<String> categories;
}
```

### Item (Herencia JOINED)
```java
@Entity @Inheritance(JOINED)
abstract class Item {
  String id, name, description, imageUrl, category;
  BigDecimal price;
  Tenant tenant;
  boolean active;
}

@Entity class Product extends Item {
  Integer stock;
  String sku;
  ProductType type; // PHYSICAL, DIGITAL
}

@Entity class ServiceItem extends Item {
  Integer durationMinutes, maxCapacity;
  ScheduleType scheduleType; // ON_DEMAND, SCHEDULED, RECURRING
  boolean requiresBooking;
  Set<DayOfWeek> availableDays;
  LocalTime workStartTime, workEndTime;
  Integer slotIntervalMinutes;
}
```

### Order
```java
@Entity class Order {
  String id;
  User user;
  Tenant tenant;
  List<OrderItem> items; // @OneToMany
  BigDecimal total;
  OrderStatus status; // PENDING, CONFIRMED, PREPARING, COMPLETED, CANCELLED
  PaymentMethod paymentMethod;
  String notes;
  LocalDateTime createdAt, updatedAt;
}

@Entity class OrderItem {
  String id;
  Order order;
  Item item;
  Integer quantity;
  BigDecimal priceAtPurchase;
  String itemName, itemType; // Snapshot para items eliminados
  // Booking fields (solo si es servicio):
  LocalDate bookingDate;
  LocalTime bookingTime;
}
```

### Booking
```java
@Entity class Booking {
  String id;
  ServiceItem service;
  Order order;
  OrderItem orderItem;
  Tenant tenant;
  User user;
  LocalDate bookingDate;
  LocalTime startTime, endTime;
  BookingStatus status; // PENDING, CONFIRMED, CANCELLED, COMPLETED, NO_SHOW
  String customerName, customerEmail, customerPhone, notes;
}
```

### Payment
```java
@Entity class Payment {
  String id;
  Order order; // @OneToOne
  Tenant tenant;
  PaymentMethod method; // CASH, MERCADO_PAGO, BANK_TRANSFER, etc.
  PaymentStatus status; // PENDING, APPROVED, REJECTED, CANCELLED
  BigDecimal amount;
  String externalId, externalStatus, paymentLink;
  String receiptUrl, receiptNotes; // Para comprobantes manuales
  LocalDateTime createdAt, confirmedAt;
}
```

---

## üîê SEGURIDAD & AUTENTICACI√ìN

### JWT
- **Secret**: APP_JWT_SECRET (env)
- **Expiration**: APP_JWT_EXP_MS (env, default 24h)
- **Claims**: email (subject), userId, role
- **Filter**: JwtAuthenticationFilter ‚Üí SecurityContext

### Roles & Permisos
```java
// SUPER_ADMIN: Gestiona toda la plataforma (/api/super-admin/**)
// ADMIN: Gestiona su tenant (/api/admin/**)
// VENDEDOR: CRUD items de su tenant
// CLIENTE: Compras, reservas, perfil
```

### SecurityConfig
- **CORS**: Habilitado para localhost:5173, incluye X-Tenant-Subdomain
- **CSRF**: Disabled (JWT stateless)
- **Public endpoints**: /api/auth/**, /api/config/current, /api/items/** (GET), /api/payments/** (webhooks)

---

## üåê BACKEND: ENDPOINTS PRINCIPALES

### Auth (/api/auth)
- `POST /register` ‚Üí Crea User + rol CLIENTE + tenant default
- `POST /login` ‚Üí Retorna JWT
- `GET /me` ‚Üí User actual (requiere auth)

### Items (/api/items)
- `GET /products` ‚Üí Lista productos del tenant actual
- `GET /services` ‚Üí Lista servicios del tenant actual
- `POST /products` ‚Üí Crea producto (ADMIN/VENDEDOR)
- `POST /services` ‚Üí Crea servicio (ADMIN/VENDEDOR)

### Orders (/api/orders)
- `POST /` ‚Üí Crea orden + reserva stock + crea bookings si hay servicios
- `GET /my-orders` ‚Üí √ìrdenes del user
- `GET /` ‚Üí Todas las √≥rdenes del tenant (ADMIN/VENDEDOR)
- `POST /{id}/cancel` ‚Üí Cancela orden + restaura stock

### Payments (/api/payments)
- `POST /` ‚Üí Crea pago (MP o manual)
- `POST /upload-receipt` ‚Üí Sube comprobante (transferencias)
- `PATCH /{id}/approve` ‚Üí Aprueba pago manual (ADMIN/VENDEDOR)
- `PATCH /{id}/reject` ‚Üí Rechaza pago + restaura stock
- `POST /webhook/mercadopago` ‚Üí Webhook de MP (p√∫blico)
- `GET /success, /failure, /pending` ‚Üí Redirects de MP

### Bookings (/api/bookings)
- `GET /available?serviceId=X&date=Y` ‚Üí Slots disponibles
- `POST /` ‚Üí Crea booking (status PENDING hasta pago)
- `POST /{id}/cancel` ‚Üí Cancela booking (24hs antes m√≠nimo)
- `GET /my-bookings` ‚Üí Bookings del user

### Admin (/api/admin)
- `GET /users` ‚Üí Todos los usuarios
- `POST /users` ‚Üí Crea usuario con tenant espec√≠fico
- `PATCH /users/{id}/role` ‚Üí Cambia rol

### Admin Stats (/api/admin/stats)
- `GET /dashboard` ‚Üí KPIs (ventas, √≥rdenes, clientes, revenue)
- `GET /daily-sales?days=30` ‚Üí Ventas diarias (chart)
- `GET /pending-payments` ‚Üí Pagos pendientes revisi√≥n
- `GET /top-products?limit=10` ‚Üí Productos m√°s vendidos
- `GET /payment-methods` ‚Üí Distribuci√≥n m√©todos de pago
- `GET /order-status` ‚Üí Distribuci√≥n estados √≥rdenes

### Customer (/api/customer)
- `GET /profile` ‚Üí Perfil del user
- `PUT /profile` ‚Üí Actualiza perfil (nombre, tel√©fono)
- `GET /orders` ‚Üí Mis √≥rdenes
- `GET /bookings` ‚Üí Mis reservas
- `GET /bookings/upcoming` ‚Üí Pr√≥ximas reservas
- `POST /bookings/{id}/cancel` ‚Üí Cancela reserva (24hs antes)
- `GET /stats` ‚Üí Estad√≠sticas del cliente

### Super Admin (/api/super-admin)
- `GET /tenants` ‚Üí TODOS los tenants (sin filtro)
- `POST /tenants` ‚Üí Crea tenant
- `PUT /tenants/{id}` ‚Üí Actualiza tenant
- `PATCH /tenants/{id}/toggle-status` ‚Üí Activa/Suspende tenant
- `PATCH /tenants/{id}/features` ‚Üí Actualiza features del tenant
- `POST /services` ‚Üí Crea servicio para un tenant espec√≠fico

### Config (/api/config)
- `GET /current` ‚Üí Configuraci√≥n del tenant actual (p√∫blico)

---

## üé® FRONTEND: ESTRUCTURA

### Context & State
```javascript
// CartContext: cart, addToCart, removeFromCart, updateQuantity, clearCart, getTotal, getTotalItems
// Persistencia en localStorage
// Validaci√≥n de stock en addToCart/updateQuantity
```

### P√°ginas
```
HomePage ‚Üí Lista productos/servicios (tabs)
LoginPage / RegisterPage
CartPage ‚Üí Lista items + summary + validaciones stock
CheckoutPage ‚Üí Selector m√©todo pago + notas ‚Üí Crea orden + pago ‚Üí Redirige a MP o success
SuccessPage / FailurePage / PendingPage ‚Üí Resultados MP
AdminPage ‚Üí Dashboard (Recharts) + Pending payments table
ManageItemsPage ‚Üí CRUD productos/servicios (tabs) + booking config
MyAccountPage ‚Üí Tabs: Overview (stats), √ìrdenes, Reservas, Perfil
SuperAdminPage ‚Üí Tabla tenants + Edit/Suspend + Crear servicio
NotFoundPage
```

### Componentes
```
Navbar ‚Üí Logo, links, carrito badge, user dropdown, roles
ProductCard / ServiceCard ‚Üí Imagen, precio, stock, agregar carrito
BookingModal ‚Üí Selector fecha + slots disponibles
Toast ‚Üí Notificaciones (success, error, warning)
ConfirmModal ‚Üí Confirmaciones (cancelar booking, vaciar carrito, etc.)
EditTenantModal ‚Üí Editar tenant (nombre, tipo, features)
AdminDashboard ‚Üí KPIs + charts (Recharts)
```

### Servicios API
```javascript
// api.js: axios instance con JWT interceptor + tenant header
// authService: register, login, getCurrentUser
// itemService: getProducts, getServices, createProduct, createService
// tenantService: getCurrentConfig
// setTenantHeader(subdomain) ‚Üí Para testing multi-tenant
```

---

## üîÑ FLUJOS CR√çTICOS

### Flujo de Compra (Producto F√≠sico)
1. Cliente agrega al carrito ‚Üí Valida stock
2. Checkout ‚Üí Selecciona m√©todo pago + notas
3. Crea orden ‚Üí Descuenta stock (OrderService)
4. Crea payment ‚Üí Genera preferencia MP (PaymentService)
5. Redirige a MP ‚Üí Usuario paga
6. Webhook MP ‚Üí Actualiza payment + order a CONFIRMED
7. Success page ‚Üí Limpia carrito

### Flujo de Reserva (Servicio con Booking)
1. Cliente ve servicio ‚Üí Click "Reservar"
2. BookingModal ‚Üí Selecciona fecha + slot disponible
3. Agrega al carrito con bookingDate + bookingTime
4. Checkout ‚Üí Crea orden + OrderItem con booking data
5. OrderService ‚Üí Crea Booking (status PENDING)
6. Pago confirmado ‚Üí PaymentService.confirmOrderBookings() ‚Üí Booking a CONFIRMED

### Flujo de Cancelaci√≥n
**Orden**:
1. Cliente/Admin cancela orden
2. OrderService.cancelOrder() ‚Üí Restaura stock de productos f√≠sicos
3. Order.status = CANCELLED

**Booking**:
1. Cliente cancela reserva (validaci√≥n 24hs antes)
2. BookingService.cancelBooking() ‚Üí Booking.status = CANCELLED
3. Si hay orden asociada, considerar cancelar orden completa

**Pago Rechazado (MP o Manual)**:
1. Webhook MP status=rejected O Admin rechaza manual
2. PaymentService ‚Üí Payment.status = REJECTED
3. OrderService.restoreStock() ‚Üí Devuelve stock
4. Order.status = CANCELLED
5. BookingService.cancelOrderBookings() ‚Üí Cancela reservas

### Multi-Tenant Testing Local
```javascript
// frontend/src/App.jsx (en desarrollo)
api.defaults.headers.common['X-Tenant-Subdomain'] = 'beauty-test';

// O modificar /etc/hosts:
// 127.0.0.1 beauty-test.localhost
```

---

## üöÄ DEPLOYMENT & ENV VARS

### Backend (.env.local)
```properties
SPRING_PROFILES_ACTIVE=local
PGHOST=localhost
PGPORT=5432
PGDATABASE=coredb
PGUSER=postgres
PGPASSWORD=admin
APP_JWT_SECRET=desarrollo-local-32-caracteres-minimo-muy-seguro
APP_JWT_EXP_MS=86400000
PORT=8080
MERCADOPAGO_ACCESS_TOKEN=xxx
MERCADOPAGO_PUBLIC_KEY=xxx
MERCADOPAGO_WEBHOOK_SECRET=xxx
MERCADOPAGO_WEBHOOK_URL=https://xxx.ngrok.io/api/payments/webhook/mercadopago
MERCADOPAGO_SUCCESS_URL=http://localhost:5173/success
MERCADOPAGO_FAILURE_URL=http://localhost:5173/failure
MERCADOPAGO_PENDING_URL=http://localhost:5173/pending
```

### Frontend
```bash
VITE_API_URL=http://localhost:8080
```

### Usuarios de Testing
```
Super Admin: superadmin@platform.com / superadmin123
Admin: admin@admin.com / admin123
```

---

## ‚úÖ FEATURES COMPLETADAS

### Core
- [x] Sistema multi-tenant completo
- [x] Autenticaci√≥n JWT + roles
- [x] CRUD productos/servicios
- [x] Sistema de carrito (Context + localStorage)
- [x] Checkout + creaci√≥n √≥rdenes
- [x] Gesti√≥n de stock (descuento + restauraci√≥n)

### Booking
- [x] Servicios con reserva
- [x] Disponibilidad configurable (d√≠as, horarios, slots)
- [x] Modal de selecci√≥n de turnos
- [x] Validaci√≥n de conflictos
- [x] Cancelaci√≥n con restricci√≥n 24hs

### Payments
- [x] Integraci√≥n MercadoPago (preferencias + webhooks)
- [x] Pagos manuales (transferencia + comprobante)
- [x] Aprobaci√≥n/rechazo manual (admin)
- [x] Restauraci√≥n de stock en fallos
- [x] P√°ginas de resultado (success/failure/pending)

### Admin
- [x] Dashboard con KPIs (Recharts)
- [x] Ventas diarias (chart)
- [x] Top productos
- [x] Pagos pendientes de revisi√≥n
- [x] Distribuci√≥n m√©todos de pago
- [x] Gesti√≥n de usuarios

### Super Admin
- [x] Panel de gesti√≥n de tenants
- [x] Activar/Suspender tenants
- [x] Editar configuraci√≥n de tenants
- [x] Crear servicios para tenants espec√≠ficos

### Cliente
- [x] Panel "Mi Cuenta" (Overview, √ìrdenes, Reservas, Perfil)
- [x] Ver historial de compras
- [x] Ver reservas pr√≥ximas/pasadas
- [x] Cancelar reservas (24hs)
- [x] Editar perfil (nombre, tel√©fono)

---

## üîÑ PENDIENTE (TODO.md - Priorizado)

### üî• Prioridad Alta (Siguiente Sesi√≥n)
1. **Sistema de Delivery** ‚Üê PROPUESTO POR FRANCIS
    - [ ] Modelo Address (calle, ciudad, CP, provincia)
    - [ ] CRUD direcciones (User ‚Üí List<Address>)
    - [ ] DeliveryService: c√°lculo de env√≠o
    - [ ] TenantConfig.DeliveryConfig: freeDeliveryThreshold, deliveryCost, zones
    - [ ] Endpoint /api/orders/calculate-delivery
    - [ ] Frontend: AddressManager en Mi Cuenta
    - [ ] Frontend: Selector direcci√≥n en Checkout
    - [ ] Checkout: Mostrar "Env√≠o gratis" cuando aplique
    - [ ] Validaci√≥n: Productos f√≠sicos requieren direcci√≥n

2. **Testing completo flujo MercadoPago**
    - [ ] Testear success/pending/failure en dev
    - [ ] Verificar restauraci√≥n stock en todos los casos
    - [ ] Validar webhooks con ngrok

### üìã Prioridad Media
3. **WhatsApp Floating Button**
    - [ ] Bot√≥n flotante esquina inferior derecha
    - [ ] N√∫mero configurable en TenantConfig
    - [ ] Link directo wa.me

4. **Google OAuth Login**
    - [ ] Login con Google
    - [ ] Auto-registro si no existe
    - [ ] Mantener JWT existente

### üîß Refactoring
- [ ] Agregar soft-delete
- [ ] Cache configuraci√≥n tenants
- [ ] √çndices BD para performance
- [ ] Rate limiting endpoints p√∫blicos
- [ ] Logging estructurado (SLF4J)

### üêõ Bugs Conocidos
- [ ] Validar webhooks MP en producci√≥n
- [ ] Manejo de timezones en bookings
- [ ] Validar emails √∫nicos por tenant

---

## üìù DECISIONES T√âCNICAS IMPORTANTES

### ¬øPor qu√© JOINED herencia para Items?
- Permite queries polim√≥rficas eficientes
- Evita nullables en tabla base
- F√°cil agregar tipos nuevos (ej: DigitalProduct)

### ¬øPor qu√© ThreadLocal para TenantContext?
- Aislamiento autom√°tico por request
- No contamina par√°metros de m√©todos
- Compatible con transacciones Spring

### ¬øPor qu√© snapshot en OrderItem?
- Preserva datos si se elimina Item
- Auditabilidad (precio al momento de compra)
- Evita inconsistencias en reportes hist√≥ricos

### ¬øPor qu√© JSONB para TenantConfig?
- Flexibilidad para configs custom por tenant
- No requiere migraciones para agregar campos
- PostgreSQL indexa JSONB eficientemente

### ¬øPor qu√© external_reference en MP en lugar de payment_id?
- MP puede reintentar pagos con mismo payment_id
- external_reference es nuestro Order.id (√∫nico)
- Evita duplicados y facilita tracking

---

## üîó LINKS IMPORTANTES

- **Chat anteriores**: 
- https://claude.ai/chat/f73e801d-c1ea-45ee-8a89-e517c03886ee
- https://claude.ai/chat/f052be26-377a-40ee-a877-08cfae28a7b3
- **Repo Git**: https://github.com/franhii/base-template-project
- **Docs MP**: https://www.mercadopago.com.ar/developers/es/docs

---

## üìä M√âTRICAS DEL PROYECTO

- **Backend**: ~70 archivos Java
- **Frontend**: ~40 archivos JSX/CSS
- **Total LOC**: ~15,000 (estimado)
- **Endpoints**: ~50
- **Entidades**: 10 principales
- **Tiempo desarrollo**: ~4-5 sesiones

---

## üéØ PR√ìXIMA SESI√ìN

**Objetivo**: Sistema de Delivery con env√≠o gratis
**Archivos necesarios**:
- TenantConfig.java
- OrderService.java
- CheckoutPage.jsx
- MyAccountPage.jsx

**Resultado esperado**:
- Address model + CRUD
- C√°lculo de env√≠o en checkout
- Mensaje "Env√≠o gratis" din√°mico
- Validaci√≥n productos f√≠sicos requieren direcci√≥n

---

## üìñ GLOSARIO

- **Tenant**: Cliente/negocio que usa la plataforma
- **Item**: Abstracci√≥n de Product + ServiceItem
- **Booking**: Reserva de un servicio en fecha/hora espec√≠fica
- **OrderItem**: L√≠nea de una orden (puede incluir booking data)
- **Slot**: Horario disponible para reserva
- **External Reference**: ID de nuestra orden usado en MercadoPago
- **Snapshot**: Copia de datos al momento de la transacci√≥n (ej: priceAtPurchase)

---

**üîÑ ACTUALIZAR ESTE ARCHIVO AL FINAL DE CADA SESI√ìN**


## ‚úÖ FEATURES COMPLETADAS
- HACER EL PROJECT_MEMORY.MD

## üîÑ PENDIENTE
- [ ] Objetivo: Sistema de Delivery con env√≠o gratis Archivos necesarios:

TenantConfig.java
OrderService.java
CheckoutPage.jsx
MyAccountPage.jsx
Resultado esperado:

Address model + CRUD
C√°lculo de env√≠o en checkout
Mensaje "Env√≠o gratis" din√°mico
Validaci√≥n productos f√≠sicos requieren direcci√≥n


## üéØ PR√ìXIMA SESI√ìN
Objetivo: LO PENDIENTE.

